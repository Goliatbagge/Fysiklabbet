<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brytningslagen - Fysiklabbet</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Version 1.9 - Further compressed simulation height -->
</head>
<body class="bg-sky-100 text-slate-800">
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">⚛️</span>
                <span class="logo-text">Fysiklabbet</span>
            </a>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Hem</a></li>
                <li><a href="fysik1.html" class="nav-link">Fysik 1</a></li>
                <li><a href="fysik2.html" class="nav-link active">Fysik 2</a></li>
            </ul>
        </div>
    </nav>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useCallback, useMemo } = React;

        const Slider = ({ id, label, value, min, max, step, onChange, displayPrecision = 2 }) => {
            return (
                <div className="flex flex-col gap-2">
                    <div className="flex justify-between text-sm">
                        <label htmlFor={id} className="text-slate-700">{label}</label>
                        <span className="font-mono text-sky-700">{value.toFixed(displayPrecision).replace('.', ',')}</span>
                    </div>
                    <input
                        id={id}
                        type="range"
                        min={min}
                        max={max}
                        step={step}
                        value={value}
                        onChange={onChange}
                        className="w-full h-2 bg-sky-200 rounded-lg appearance-none cursor-pointer accent-sky-500"
                    />
                </div>
            );
        };

        const ControlsView = ({ n1, setN1, n2, setN2, incidentAngle, setIncidentAngle }) => {
            const theta1Rad = incidentAngle * (Math.PI / 180);
            const sinTheta2 = (n1 / n2) * Math.sin(theta1Rad);
            const isTIR = Math.abs(sinTheta2) > 1;
            const theta2 = isTIR ? 0 : -Math.asin(sinTheta2) * (180 / Math.PI);

            return (
                <div className="bg-white/60 backdrop-blur-sm rounded-xl p-6 h-full shadow-2xl flex flex-col gap-6">
                    <div>
                        <h2 className="text-xl font-semibold text-sky-600 mb-2">Inställningar</h2>
                        <p className="text-sm text-slate-600">
                            Justera parametrarna med reglagen nedan, eller dra i ljusstrålen för att ändra infallsvinkeln.
                        </p>
                    </div>

                    <div className="space-y-6">
                        <Slider
                            id="incident-angle"
                            label={<>Infallsvinkel (<i>i</i>)</>}
                            min={-89.9}
                            max={89.9}
                            step={0.1}
                            value={incidentAngle}
                            onChange={(e) => setIncidentAngle(parseFloat(e.target.value))}
                            displayPrecision={1}
                        />
                        <Slider
                            id="n2-slider"
                            label="Brytningsindex Block (n₂)"
                            min={1.00}
                            max={2.50}
                            step={0.01}
                            value={n2}
                            onChange={(e) => setN2(parseFloat(e.target.value))}
                        />
                        <Slider
                            id="n1-slider"
                            label="Brytningsindex Medium 1 (n₁)"
                            min={1.00}
                            max={2.50}
                            step={0.01}
                            value={n1}
                            onChange={(e) => setN1(parseFloat(e.target.value))}
                        />
                    </div>

                    <div className="mt-4 pt-6 border-t border-sky-200">
                        <h2 className="text-xl font-semibold text-sky-600 mb-4">Snells Lag</h2>
                        <div className="bg-sky-50 rounded-lg p-4 text-center">
                            <p className="text-lg text-emerald-600">
                                <span style={{fontStyle: 'italic'}}>n</span>
                                <sub>1</sub> sin <span style={{fontStyle: 'italic'}}>i</span> = <span style={{fontStyle: 'italic'}}>n</span>
                                <sub>2</sub> sin <span style={{fontStyle: 'italic'}}>b</span>
                            </p>
                        </div>
                    </div>

                    <div className="mt-2 space-y-3">
                        <div className="flex justify-between items-center bg-sky-100/70 p-3 rounded-lg">
                            <span className="text-slate-700">Infallsvinkel (<i>i</i>):</span>
                            <span className="font-mono text-lg text-slate-900">{incidentAngle.toFixed(1).replace('.', ',')}°</span>
                        </div>
                        <div className="flex justify-between items-center bg-sky-100/70 p-3 rounded-lg">
                            <span className="text-slate-700">Brytningsvinkel (<i>b</i>):</span>
                            {isTIR ? (
                                <span className="font-bold text-lg text-red-500">Total intern reflektion</span>
                            ) : (
                                <span className="font-mono text-lg text-slate-900">{theta2.toFixed(1).replace('.', ',')}°</span>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SimulationView = ({ n1, n2, incidentAngle, setIncidentAngle }) => {
            const svgRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);

            const VIEWBOX_WIDTH = 800;
            const VIEWBOX_HEIGHT = 450;
            const BLOCK_Y = 125;
            const BLOCK_HEIGHT = 200;
            const ENTRY_X = VIEWBOX_WIDTH / 2;
            const RAY_LENGTH = 175;

            const calculations = useMemo(() => {
                const theta1Rad = incidentAngle * (Math.PI / 180);
                const sinTheta2 = (n1 / n2) * Math.sin(theta1Rad);
                const isTIR = n1 > n2 && Math.abs(sinTheta2) > 1;
                const theta2Rad = isTIR ? 0 : -Math.asin(sinTheta2);

                const p1 = {
                    x: ENTRY_X + RAY_LENGTH * Math.sin(theta1Rad),
                    y: BLOCK_Y - RAY_LENGTH * Math.cos(theta1Rad)
                };
                const p2 = { x: ENTRY_X, y: BLOCK_Y };

                let p3, p4;

                if (isTIR) {
                    p3 = {
                        x: ENTRY_X - RAY_LENGTH * Math.sin(theta1Rad),
                        y: BLOCK_Y - RAY_LENGTH * Math.cos(theta1Rad)
                    };
                    p4 = p3;
                } else {
                    const internalDx = BLOCK_HEIGHT * Math.tan(theta2Rad);
                    p3 = { x: ENTRY_X + internalDx, y: BLOCK_Y + BLOCK_HEIGHT };

                    p4 = {
                        x: p3.x - RAY_LENGTH * Math.sin(theta1Rad),
                        y: p3.y + RAY_LENGTH * Math.cos(theta1Rad)
                    };
                }

                return { p1, p2, p3, p4, theta1Rad, theta2Rad, isTIR };
            }, [incidentAngle, n1, n2]);

            const { p1, p2, p3, p4, theta1Rad, theta2Rad, isTIR } = calculations;

            const handleInteraction = useCallback((e) => {
                if (!svgRef.current) return;

                const svg = svgRef.current;
                const rect = svg.getBoundingClientRect();

                let clientX, clientY;
                if (e.touches) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                const x = (clientX - rect.left) * (VIEWBOX_WIDTH / rect.width);
                const y = (clientY - rect.top) * (VIEWBOX_HEIGHT / rect.height);

                const dx = x - p2.x;
                const dy = y - p2.y;

                if (dy >= 0) return;

                let angleRad = Math.atan(dx / -dy);
                let angleDeg = angleRad * (180 / Math.PI);

                const clampedAngle = Math.max(-89.9, Math.min(89.9, angleDeg));
                setIncidentAngle(clampedAngle);

            }, [p2.x, p2.y, setIncidentAngle]);

            const handleMouseDown = (e) => {
                setIsDragging(true);
                handleInteraction(e);
            };

            const handleMouseUp = () => setIsDragging(false);

            const handleMouseMove = (e) => {
                if (isDragging) {
                    handleInteraction(e);
                }
            };

            const handleTouchStart = (e) => {
                setIsDragging(true);
                handleInteraction(e);
            };

            const handleTouchMove = (e) => {
                if (isDragging) {
                    e.preventDefault();
                    handleInteraction(e);
                }
            };

            const getArcPath = (cx, cy, radius, angle1Rad, angle2Rad) => {
                const startAngleRad = Math.min(angle1Rad, angle2Rad);
                const endAngleRad = Math.max(angle1Rad, angle2Rad);

                const startX = cx + radius * Math.sin(startAngleRad);
                const startY = cy - radius * Math.cos(startAngleRad);
                const endX = cx + radius * Math.sin(endAngleRad);
                const endY = cy - radius * Math.cos(endAngleRad);

                return `M ${startX} ${startY} A ${radius} ${radius} 0 0 1 ${endX} ${endY}`;
            };

            const getDownwardArcPath = (cx, cy, radius, angle1Rad, angle2Rad) => {
                const startAngleRad = Math.min(angle1Rad, angle2Rad);
                const endAngleRad = Math.max(angle1Rad, angle2Rad);

                const startX = cx + radius * Math.sin(startAngleRad);
                const startY = cy + radius * Math.cos(startAngleRad);
                const endX = cx + radius * Math.sin(endAngleRad);
                const endY = cy + radius * Math.cos(endAngleRad);

                return `M ${startX} ${startY} A ${radius} ${radius} 0 0 0 ${endX} ${endY}`;
            };

            return (
                <div className="w-full h-full bg-white/60 backdrop-blur-sm rounded-xl overflow-hidden shadow-2xl"
                    onMouseUp={handleMouseUp}
                    onMouseLeave={handleMouseUp}
                    onMouseMove={handleMouseMove}
                    onTouchEnd={handleMouseUp}
                    onTouchCancel={handleMouseUp}
                    onTouchMove={handleTouchMove}
                >
                    <svg
                        ref={svgRef}
                        viewBox={`0 0 ${VIEWBOX_WIDTH} ${VIEWBOX_HEIGHT}`}
                        className="w-full h-full cursor-pointer"
                        onMouseDown={handleMouseDown}
                        onTouchStart={handleTouchStart}
                    >
                        <defs>
                            <marker
                                id="arrow"
                                viewBox="0 0 10 10"
                                refX="8"
                                refY="5"
                                markerWidth="4"
                                markerHeight="4"
                                orient="auto"
                            >
                                <path d="M 0 0 L 10 5 L 0 10 z" fill="#fbbf24" />
                            </marker>
                            <linearGradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style={{stopColor: 'rgb(34 211 238 / 0.25)'}} />
                                <stop offset="100%" style={{stopColor: 'rgb(14 165 233 / 0.45)'}} />
                            </linearGradient>
                            <linearGradient id="shimmeringWhiteGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style={{stopColor: 'rgba(255, 255, 255, 0.8)'}} />
                                <stop offset="100%" style={{stopColor: 'rgba(230, 240, 255, 0.7)'}} />
                            </linearGradient>
                        </defs>

                        <rect x="0" y="0" width={VIEWBOX_WIDTH} height={BLOCK_Y} fill="rgb(186, 230, 253)"/>
                        <rect x="0" y={BLOCK_Y} width={VIEWBOX_WIDTH} height={BLOCK_HEIGHT} fill="url(#shimmeringWhiteGradient)"/>
                        <rect x="0" y={BLOCK_Y + BLOCK_HEIGHT} width={VIEWBOX_WIDTH} height={VIEWBOX_HEIGHT - BLOCK_Y - BLOCK_HEIGHT} fill="rgb(186, 230, 253)"/>

                        <text x="20" y="40" fill="#0c4a6e" fontSize="24" fontWeight="medium">
                            Medium 1 (<tspan fontStyle="italic">n</tspan>
                            <tspan fontSize="16" dy="4">1</tspan>
                            <tspan dy="-4"> = {n1.toFixed(2).replace('.', ',')}</tspan>)
                        </text>
                        <text x="20" y={BLOCK_Y + 40} fill="#334155" fontSize="24" fontWeight="medium">
                            Medium 2 (<tspan fontStyle="italic">n</tspan>
                            <tspan fontSize="16" dy="4">2</tspan>
                            <tspan dy="-4"> = {n2.toFixed(2).replace('.', ',')}</tspan>)
                        </text>

                        <line x1={p2.x} y1="0" x2={p2.x} y2={VIEWBOX_HEIGHT} stroke="#94a3b8" strokeWidth="2" strokeDasharray="5,5" />
                        {!isTIR && <line x1={p3.x} y1={BLOCK_Y} x2={p3.x} y2={VIEWBOX_HEIGHT} stroke="#94a3b8" strokeWidth="2" strokeDasharray="5,5" />}

                        <g stroke="#fbbf24" strokeWidth="3" strokeLinecap="round">
                            <line x1={p1.x} y1={p1.y} x2={p2.x} y2={p2.y} />
                            <line x1={p2.x} y1={p2.y} x2={p3.x} y2={p3.y} />
                            {!isTIR && <line x1={p3.x} y1={p3.y} x2={p4.x} y2={p4.y} />}
                        </g>

                        <g>
                            {(() => {
                                const mid1x = (p1.x + p2.x) / 2;
                                const mid1y = (p1.y + p2.y) / 2;
                                const dx1 = p2.x - p1.x;
                                const dy1 = p2.y - p1.y;
                                const len1 = Math.sqrt(dx1 * dx1 + dy1 * dy1);
                                const arrowLen = 1;
                                return <line x1={mid1x} y1={mid1y} x2={mid1x + (dx1 / len1) * arrowLen} y2={mid1y + (dy1 / len1) * arrowLen} stroke="#fbbf24" strokeWidth="3" markerEnd="url(#arrow)" />;
                            })()}
                            {(() => {
                                const mid2x = (p2.x + p3.x) / 2;
                                const mid2y = (p2.y + p3.y) / 2;
                                const dx2 = p3.x - p2.x;
                                const dy2 = p3.y - p2.y;
                                const len2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);
                                const arrowLen = 1;
                                return <line x1={mid2x} y1={mid2y} x2={mid2x + (dx2 / len2) * arrowLen} y2={mid2y + (dy2 / len2) * arrowLen} stroke="#fbbf24" strokeWidth="3" markerEnd="url(#arrow)" />;
                            })()}
                            {!isTIR && (() => {
                                const mid3x = (p3.x + p4.x) / 2;
                                const mid3y = (p3.y + p4.y) / 2;
                                const dx3 = p4.x - p3.x;
                                const dy3 = p4.y - p3.y;
                                const len3 = Math.sqrt(dx3 * dx3 + dy3 * dy3);
                                const arrowLen = 1;
                                return <line x1={mid3x} y1={mid3y} x2={mid3x + (dx3 / len3) * arrowLen} y2={mid3y + (dy3 / len3) * arrowLen} stroke="#fbbf24" strokeWidth="3" markerEnd="url(#arrow)" />;
                            })()}
                        </g>

                        {isTIR && <text x={p2.x + 15} y={p2.y - 40} fill="#ef4444" fontSize="18" fontWeight="bold">Total intern reflektion</text>}

                        <g>
                            <path d={getArcPath(p2.x, p2.y, 40, 0, theta1Rad)} stroke="#0ea5e9" strokeWidth="2" fill="none"/>
                            <text x={p2.x + 50 * Math.sin(theta1Rad/2)} y={p2.y - 50 * Math.cos(theta1Rad/2)} fill="#0ea5e9" fontSize="18" fontStyle="italic" textAnchor="middle">i</text>

                            {isTIR ? (
                                <g>
                                    <path d={getArcPath(p2.x, p2.y, 60, 0, -theta1Rad)} stroke="#ec4899" strokeWidth="2" fill="none"/>
                                    <text x={p2.x + 70 * Math.sin(-theta1Rad/2)} y={p2.y - 70 * Math.cos(-theta1Rad/2)} fill="#ec4899" fontSize="18" fontStyle="italic" textAnchor="middle">i'</text>
                                </g>
                            ) : (
                                <g>
                                    <path d={getDownwardArcPath(p2.x, p2.y, 40, 0, theta2Rad)} stroke="#8b5cf6" strokeWidth="2" fill="none" />
                                    <text x={p2.x + 55 * Math.sin(theta2Rad/2)} y={p2.y + 55 * Math.cos(theta2Rad/2)} fill="#8b5cf6" fontSize="18" fontStyle="italic" textAnchor="middle">b</text>
                                </g>
                            )}
                        </g>

                        {!isTIR && (
                            <g>
                                <path d={getArcPath(p3.x, p3.y, 40, 0, -theta2Rad)} stroke="#8b5cf6" strokeWidth="2" fill="none"/>
                                <text x={p3.x - 50 * Math.sin(theta2Rad/2)} y={p3.y - 50 * Math.cos(theta2Rad/2)} fill="#8b5cf6" fontSize="18" fontStyle="italic" textAnchor="middle">i</text>

                                <path d={getDownwardArcPath(p3.x, p3.y, 40, 0, -theta1Rad)} stroke="#0ea5e9" strokeWidth="2" fill="none" />
                                <text x={p3.x - 55 * Math.sin(theta1Rad/2)} y={p3.y + 55 * Math.cos(theta1Rad/2)} fill="#0ea5e9" fontSize="18" fontStyle="italic" textAnchor="middle">b</text>
                            </g>
                        )}

                    </svg>
                </div>
            );
        };

        const App = () => {
            const [n1, setN1] = useState(1.0);
            const [n2, setN2] = useState(1.52);
            const [incidentAngle, setIncidentAngle] = useState(-40);

            return (
                <div className="min-h-screen bg-sky-100 text-slate-800 font-sans flex flex-col">
                    <header className="p-4 sm:p-6 bg-white/60 backdrop-blur-sm border-b border-sky-200 shadow-lg text-center sticky top-0 z-10">
                        <h1 className="text-2xl sm:text-3xl font-bold text-sky-600">Brytningslagen</h1>
                        <p className="text-slate-600 mt-1 text-sm sm:text-base">Utforska ljusets brytning vid gränsytan mellan två medier.</p>
                    </header>

                    <main className="flex-grow flex flex-col lg:flex-row p-4 sm:p-6 gap-6">
                        <div className="lg:w-1/3 xl:w-1/4 flex-shrink-0">
                            <ControlsView
                                n1={n1}
                                setN1={setN1}
                                n2={n2}
                                setN2={setN2}
                                incidentAngle={incidentAngle}
                                setIncidentAngle={setIncidentAngle}
                            />
                        </div>
                        <div className="flex-grow lg:w-2/3 xl:w-3/4 min-h-[400px] lg:min-h-0">
                            <SimulationView
                                n1={n1}
                                n2={n2}
                                incidentAngle={incidentAngle}
                                setIncidentAngle={setIncidentAngle}
                            />
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
